<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Multi-Clock Phasing Simulator</title>
    <style>
      :root {
        --bg: #0e1013;
        --panel: #161a20;
        --ink: #e6e8ec;
        --ink2: #a9b0bd;
        --line: #222a35;
        --accent: #50d0ff;
        --warn: #ff6b6b;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--ink);
        font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      }
      header {
        padding: 12px 14px;
        background: linear-gradient(180deg, #141820, #10141a);
        border-bottom: 1px solid var(--line);
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      header h1 {
        font-size: 16px;
        margin: 0;
        font-weight: 600;
      }
      .spacer {
        flex: 1;
      }
      .btn {
        background: #1f2732;
        color: var(--ink);
        border: 1px solid #2c3646;
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      .btn.alt {
        background: #222b25;
        border-color: #2c3a31;
      }
      .btn.warn {
        background: #2c2020;
        border-color: #3b2727;
        color: #ffd9d9;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 16px;
        padding: 16px;
        height: calc(100% - 56px);
      }
      .stage {
        background: #0c0f13;
        border: 1px solid #1d2530;
        border-radius: 12px;
        position: relative;
        overflow: auto;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .clocks {
        display: flex;
        gap: 18px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        padding: 18px;
      }
      .panel {
        background: var(--panel);
        border: 1px solid #1f2732;
        border-radius: 12px;
        padding: 12px;
        overflow: auto;
      }
      .lane {
        background: #12161c;
        border: 1px solid #232c39;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 12px;
      }
      .lane h3 {
        margin: 0 0 6px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .lane .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
        margin: 8px 0;
      }
      .row label {
        color: var(--ink2);
      }
      .group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .canvas-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .meta {
        color: var(--ink2);
        font-size: 12px;
      }
      .foot {
        color: #8a93a3;
        font-size: 12px;
        padding: 6px 12px 0;
      }
      input[type="range"],
      select {
        accent-color: var(--accent);
      }
      /* Mobile / narrow screens */
      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
          grid-auto-rows: auto;
        }
        .panel {
          display: none;
          max-height: 50vh;
        }
        .panel.open {
          display: block;
        }
        .stage {
          order: 1;
        }
        .panel {
          order: 2;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Three-Clock Phasing Simulator</h1>
      <button id="audioBtn" class="btn">Enable Audio</button>
      <button id="toggleControls" class="btn alt" aria-expanded="false">
        Controls
      </button>
      <div class="spacer"></div>
      <button id="startAll" class="btn">Start all</button>
      <button id="stopAll" class="btn alt">Stop all</button>
      <button id="addClock" class="btn">Add clock</button>
    </header>

    <div class="grid">
      <div class="stage"><div id="clocks" class="clocks"></div></div>
      <aside id="panel" class="panel"></aside>
    </div>

    <script>
      (() => {
        // ------------------ Audio (iOS-safe) ------------------
        let ac = null;
        function ensureAudio() {
          if (!ac) {
            ac = new (window.AudioContext || window.webkitAudioContext)();
          }
          if (ac.state === "suspended") ac.resume();
          // iOS unlock shim: play a very short silent blip
          const t = ac.currentTime + 0.01;
          const g = ac.createGain();
          g.gain.value = 0.0001;
          const o = ac.createOscillator();
          o.type = "square";
          o.frequency.value = 100;
          o.connect(g).connect(ac.destination);
          o.start(t);
          o.stop(t + 0.01);
        }
        document
          .getElementById("audioBtn")
          .addEventListener("click", ensureAudio);

        // ------------------ Model ------------------
        const COLORS = [
          "#50d0ff",
          "#ffc24b",
          "#7dff78",
          "#ff6b6b",
          "#c792ea",
          "#78ffd5",
          "#ffb86c",
        ];
        let colorIdx = 0;

        function makeClock(id, shape = "square", tempo = 2.0) {
          return {
            id,
            shape,
            scale: shape === "circle" ? 1.3 : 1.0,
            color: COLORS[colorIdx++ % COLORS.length],
            audioHz: 1800,
            hz: tempo,
            running: true,
          };
        }

        // initial three: A,B squares; C circle
        let clocks = [
          makeClock("A", "square", 2.0),
          makeClock("B", "square", 1.98),
          makeClock("C", "circle", 2.02),
        ];

        // state per clock
        const state = {};
        function initState(c) {
          const now = performance.now();
          state[c.id] = {
            minute: 0,
            polarity: false,
            period: c.hz > 0 ? 1000 / c.hz : Infinity,
            nextDue: now + (c.hz > 0 ? 1000 / c.hz : 1e9),
            activeUntil: 0,
          };
        }
        clocks.forEach(initState);

        // ------------------ UI build ------------------
        const clocksDiv = document.getElementById("clocks");
        const panel = document.getElementById("panel");
        const canvases = {};

        function rebuildFaces() {
          clocksDiv.innerHTML = "";
          for (const c of clocks) {
            const wrap = document.createElement("div");
            wrap.className = "canvas-wrap";
            const base = 220,
              size = Math.round(base * (c.shape === "circle" ? c.scale : 1.0));
            const canvas = document.createElement("canvas");
            canvas.width = size;
            canvas.height = size;
            canvas.style.background = "#0d1117";
            canvas.style.border = "1px solid #222a35";
            canvas.style.borderRadius = c.shape === "circle" ? "50%" : "10px";
            const meta = document.createElement("div");
            meta.className = "meta";
            meta.innerHTML = `<b>${c.id}</b> – ${c.shape}${
              c.shape === "circle" ? " (×1.3)" : ""
            }`;
            wrap.appendChild(canvas);
            wrap.appendChild(meta);
            clocksDiv.appendChild(wrap);
            canvases[c.id] = canvas;
          }
        }

        function rebuildPanel() {
          panel.innerHTML = "";
          for (const c of clocks) {
            const s = state[c.id];
            const box = document.createElement("div");
            box.className = "lane";
            box.innerHTML = `
      <h3><span class="dot" style="background:${c.color}; box-shadow:0 0 10px ${
              c.color
            }80"></span>
          Clock ${c.id}</h3>
      <div class="row">
        <label>Shape</label>
        <select data-act="shape" data-id="${c.id}">
          <option value="square"${
            c.shape === "square" ? " selected" : ""
          }>square</option>
          <option value="circle"${
            c.shape === "circle" ? " selected" : ""
          }>circle</option>
        </select>
      </div>
      <div class="row">
        <label>Tempo (Hz): <b><span data-bind="hzVal-${c.id}">${c.hz.toFixed(
              2
            )}</span></b></label>
        <input type="range" min="0" max="5" step="0.01" value="${
          c.hz
        }" data-act="tempo" data-id="${c.id}">
      </div>
      <div class="group">
        <button class="btn" data-act="toggle" data-id="${c.id}">${
              c.running ? "Stop" : "Start"
            }</button>
        <button class="btn warn" data-act="remove" data-id="${
          c.id
        }">Remove</button>
      </div>
      <div class="meta" data-bind="meta-${c.id}"></div>
    `;
            panel.appendChild(box);
          }
        }

        // event delegation for panel controls
        panel.addEventListener("input", (e) => {
          const act = e.target.getAttribute("data-act");
          const id = e.target.getAttribute("data-id");
          if (!act || !id) return;
          const c = clocks.find((x) => x.id === id);
          if (!c) return;
          if (act === "tempo") {
            const v = parseFloat(e.target.value);
            c.hz = v;
            state[id].period = v > 0 ? 1000 / v : Infinity;
            // don't reset nextDue — keeps phase
            const b = panel.querySelector(`[data-bind="hzVal-${id}"]`);
            if (b) b.textContent = v.toFixed(2);
          }
          if (act === "shape") {
            c.shape = e.target.value;
            c.scale = c.shape === "circle" ? 1.3 : 1.0;
            rebuildFaces(); // reflow canvases
          }
        });
        panel.addEventListener("click", (e) => {
          const act = e.target.getAttribute("data-act");
          const id = e.target.getAttribute("data-id");
          if (!act || !id) return;
          const c = clocks.find((x) => x.id === id);
          if (!c) return;
          if (act === "toggle") {
            c.running = !c.running;
            if (c.running) {
              state[id].period = c.hz > 0 ? 1000 / c.hz : Infinity;
              state[id].nextDue =
                performance.now() + (c.hz > 0 ? 1000 / c.hz : 1e9);
            }
            e.target.textContent = c.running ? "Stop" : "Start";
          }
          if (act === "remove") {
            // keep at least 1 clock
            if (clocks.length <= 1) return;
            delete canvases[id];
            delete state[id];
            const idx = clocks.findIndex((x) => x.id === id);
            if (idx >= 0) clocks.splice(idx, 1);
            rebuildFaces();
            rebuildPanel();
          }
        });

        // global buttons
        document.getElementById("startAll").onclick = () => {
          const now = performance.now();
          clocks.forEach((c) => {
            c.running = true;
            state[c.id].period = c.hz > 0 ? 1000 / c.hz : Infinity;
            state[c.id].nextDue = now + (c.hz > 0 ? 1000 / c.hz : 1e9);
          });
          rebuildPanel();
        };
        document.getElementById("stopAll").onclick = () => {
          clocks.forEach((c) => (c.running = false));
          rebuildPanel();
        };
        document.getElementById("addClock").onclick = () => {
          // create new id (A..Z then A1, A2...)
          let nid;
          const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
          for (let i = 0; i < letters.length; i++) {
            const cand = letters[i];
            if (!clocks.find((x) => x.id === cand)) {
              nid = cand;
              break;
            }
          }
          if (!nid) {
            let n = 1;
            while (!nid) {
              const cand = "A" + n;
              if (!clocks.find((x) => x.id === cand)) nid = cand;
              n++;
            }
          }
          const newClock = makeClock(nid, "square", 2.0);
          clocks.push(newClock);
          initState(newClock);
          rebuildFaces();
          rebuildPanel();
        };

        // controls drawer on mobile
        const ctrlBtn = document.getElementById("toggleControls");
        ctrlBtn.addEventListener("click", () => {
          const open = panel.classList.toggle("open");
          ctrlBtn.setAttribute("aria-expanded", open ? "true" : "false");
        });

        // build initial UI
        rebuildFaces();
        rebuildPanel();

        // ------------------ Click sound ------------------
        function clickSound(clock) {
          if (!ac) return;
          const t = ac.currentTime;
          const osc = ac.createOscillator();
          const gain = ac.createGain();
          osc.type = "square";
          osc.frequency.value = clock.audioHz;
          gain.gain.setValueAtTime(0.0001, t);
          gain.gain.exponentialRampToValueAtTime(0.4, t + 0.002);
          gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.02);
          osc.connect(gain).connect(ac.destination);
          osc.start(t);
          osc.stop(t + 0.03);
        }

        // ------------------ Scheduler ------------------
        function pulse(clockId, glowMs = 90) {
          const st = state[clockId],
            c = clocks.find((x) => x.id === clockId);
          if (!st || !c) return;
          st.polarity = !st.polarity;
          st.minute = (st.minute + 1) % 60;
          st.activeUntil = performance.now() + glowMs;
          clickSound(c);
        }
        function stepSchedulers(now) {
          for (const c of clocks) {
            const st = state[c.id];
            if (!c.running || !isFinite(st.period)) continue;
            while (now >= st.nextDue) {
              pulse(c.id);
              st.nextDue += st.period;
              // if tab slept a long time, snap ahead
              if (now - st.nextDue > 5000) st.nextDue = now + st.period;
            }
          }
        }

        // ------------------ Draw ------------------
        function roundRect(ctx, x, y, w, h, r) {
          const rr = Math.min(r, w / 2, h / 2);
          ctx.beginPath();
          ctx.moveTo(x + rr, y);
          ctx.arcTo(x + w, y, x + w, y + h, rr);
          ctx.arcTo(x + w, y + h, x, y + h, rr);
          ctx.arcTo(x, y + h, x, y, rr);
          ctx.arcTo(x, y, x + w, y, rr);
          ctx.closePath();
        }
        function draw() {
          const now = performance.now();
          stepSchedulers(now);
          for (const c of clocks) {
            const st = state[c.id],
              ctx = canvases[c.id].getContext("2d");
            const W = canvases[c.id].width,
              H = canvases[c.id].height,
              R = Math.min(W, H) * 0.44;
            ctx.clearRect(0, 0, W, H);
            ctx.save();
            ctx.translate(W / 2, H / 2);
            // bezel
            ctx.beginPath();
            if (c.shape === "circle") ctx.arc(0, 0, R * 1.15, 0, Math.PI * 2);
            else roundRect(ctx, -R * 1.15, -R * 1.15, R * 2.3, R * 2.3, 12);
            ctx.fillStyle = "#0f141b";
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = "#222a35";
            ctx.stroke();
            // dial ring
            ctx.beginPath();
            ctx.arc(0, 0, R, 0, Math.PI * 2);
            ctx.strokeStyle = "#2b3544";
            ctx.lineWidth = 2;
            ctx.stroke();
            // ticks
            for (let i = 0; i < 60; i++) {
              const a = -Math.PI / 2 + i * ((Math.PI * 2) / 60);
              const inner = i % 5 === 0 ? R * 0.8 : R * 0.88,
                outer = R * 0.97;
              ctx.beginPath();
              ctx.moveTo(inner * Math.cos(a), inner * Math.sin(a));
              ctx.lineTo(outer * Math.cos(a), outer * Math.sin(a));
              ctx.strokeStyle = i % 5 === 0 ? "#70819d" : "#3b4658";
              ctx.lineWidth = i % 5 === 0 ? 3 : 1;
              ctx.stroke();
            }
            // minute hand
            const ang = -Math.PI / 2 + (st.minute / 60) * Math.PI * 2;
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(Math.cos(ang) * R * 0.88, Math.sin(ang) * R * 0.88);
            ctx.strokeStyle = "#e7edf7";
            ctx.lineWidth = 4;
            ctx.lineCap = "round";
            ctx.stroke();
            // hub
            ctx.beginPath();
            ctx.arc(0, 0, 5, 0, Math.PI * 2);
            ctx.fillStyle = "#d7dee9";
            ctx.fill();
            ctx.restore();
            // coil glow
            if (now < st.activeUntil) {
              ctx.save();
              ctx.globalAlpha = 0.35;
              ctx.fillStyle = c.color;
              if (c.shape === "circle") {
                ctx.beginPath();
                ctx.arc(W / 2, H / 2, Math.min(W, H) * 0.49, 0, Math.PI * 2);
                ctx.fill();
              } else {
                ctx.fillRect(2, 2, W - 4, H - 4);
              }
              ctx.restore();
            }
            // caption
            const meta = canvases[c.id].nextSibling;
            meta.innerHTML = `<b>${c.id}</b> – ${c.shape}${
              c.shape === "circle" ? " (×1.3)" : ""
            }
      &nbsp;|&nbsp; min: <b>${String(st.minute).padStart(2, "0")}</b>
      &nbsp;|&nbsp; hz: ${c.hz.toFixed(2)}
      ${
        c.running
          ? ""
          : '&nbsp;|&nbsp;<span style="color:#ff9e9e">stopped</span>'
      }`;
          }
          requestAnimationFrame(draw);
        }
        requestAnimationFrame(draw);
      })();
    </script>
  </body>
</html>
